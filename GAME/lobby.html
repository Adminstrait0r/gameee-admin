<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPG Lobby</title>
<style>
:root {
    --bg-main: #f2efe6;
    --bg-panel: #e8e3d6;
    --border: #2b2b2b;
    --accent: #111;
    --tab-active: #d6c9a8;
    --tab-inactive: #e8e3d6;
    --green: #00b85c;
    --light-green: #c8ff7a;
    --bright-green: #b6ff5c;
    --yellow: #ffd84d;
    --red: #ff4d4d;
    --blue: #5c7cfa;
    --purple: #9d4edd;
    --orange: #ff9e4d;
}

* {
    box-sizing: border-box;
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 0;
}

body {
    margin: 0;
    background: #333;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 16px;
}

.app {
    width: 100%;
    max-width: 1200px;
    background: var(--bg-main);
    border: 3px solid var(--border);
    min-height: 700px;
}

/* TOP BAR */
.top-bar {
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    gap: 12px;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 3px solid var(--border);
    background: var(--bg-panel);
}

.profile {
    display: flex;
    align-items: center;
    gap: 15px;
}

.pfp {
    width: 70px;
    height: 70px;
    background: var(--yellow);
    border: 3px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    position: relative;
    overflow: hidden;
}

.pfp img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-info {
    font-size: 14px;
    line-height: 1.6;
    font-weight: 600;
}

.profile-info .username {
    font-size: 20px;
    color: var(--accent);
    margin-bottom: 4px;
}

.profile-info .level {
    color: var(--green);
    font-weight: 700;
}

.currency-display {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-end;
}

.gold {
    border: 2px solid var(--border);
    padding: 10px 20px;
    font-size: 14px;
    font-weight: bold;
    text-align: center;
    min-width: 120px;
    background: var(--yellow);
}

.quick-actions {
    display: flex;
    gap: 8px;
}

.btn {
    border: 2px solid var(--border);
    background: var(--bg-main);
    padding: 8px 16px;
    text-align: center;
    font-weight: 600;
    cursor: pointer;
    font-size: 12px;
    white-space: nowrap;
    transition: all 0.2s;
}

.btn:hover {
    background: var(--tab-active);
    transform: translateY(-2px);
}

.btn:active {
    transform: translateY(0);
}

.btn-primary {
    background: var(--accent);
    color: white;
}

.btn-primary:hover {
    background: #333;
}

.btn-success {
    background: var(--green);
    color: white;
}

.btn-warning {
    background: var(--orange);
    color: white;
}

/* MAIN CONTENT */
.main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    min-height: 500px;
}

/* LEFT PANEL - STATS & EQUIPMENT */
.left-panel {
    padding: 25px;
    border-right: 3px solid var(--border);
    background: var(--green);
    display: flex;
    flex-direction: column;
    gap: 25px;
}

.stats-section {
    background: rgba(0, 0, 0, 0.1);
    padding: 20px;
    border: 2px solid var(--border);
    border-radius: 8px;
}

.section-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 15px;
    color: white;
    text-align: center;
    padding-bottom: 8px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.stat-card {
    background: var(--light-green);
    padding: 15px;
    border: 2px solid var(--border);
    text-align: center;
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-3px);
}

.stat-label {
    font-size: 12px;
    color: var(--accent);
    margin-bottom: 5px;
    font-weight: 600;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--accent);
}

.health-display {
    grid-column: 1 / span 2;
    background: var(--red);
    border: 2px solid var(--border);
    padding: 15px;
    margin-top: 10px;
    position: relative;
    overflow: hidden;
}

.health-bar {
    height: 20px;
    background: rgba(0, 0, 0, 0.3);
    border: 2px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 10px;
}

.health-fill {
    height: 100%;
    background: white;
    transition: width 0.5s ease;
}

.health-text {
    color: white;
    font-weight: 600;
    text-align: center;
    font-size: 14px;
}

/* EQUIPMENT SECTION */
.equipment-section {
    background: rgba(0, 0, 0, 0.1);
    padding: 20px;
    border: 2px solid var(--border);
    border-radius: 8px;
}

.equipment-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, auto);
    gap: 12px;
    position: relative;
}

.equipment-slot {
    background: var(--light-green);
    border: 2px solid var(--border);
    min-height: 90px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
}

.equipment-slot:hover {
    background: var(--bright-green);
    transform: translateY(-2px);
}

.equipment-slot.empty {
    background: rgba(255, 255, 255, 0.2);
    border-style: dashed;
}

.equipment-icon {
    font-size: 24px;
    margin-bottom: 8px;
    color: var(--accent);
}

.slot-name {
    font-size: 12px;
    font-weight: 600;
    text-align: center;
    color: var(--accent);
    margin-bottom: 4px;
}

.item-name {
    font-size: 10px;
    color: var(--accent);
    text-align: center;
    font-weight: 600;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.item-rarity {
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 700;
}

.rarity-common { background: #808080; color: white; }
.rarity-uncommon { background: #00b85c; color: white; }
.rarity-rare { background: var(--blue); color: white; }
.rarity-epic { background: var(--purple); color: white; }
.rarity-legendary { background: var(--orange); color: white; }

/* Equipment positions */
.helmet-slot { grid-column: 2; grid-row: 1; }
.shield-slot { grid-column: 1; grid-row: 2; }
.chest-slot { grid-column: 2; grid-row: 2; }
.weapon-slot { grid-column: 3; grid-row: 2; }
.legs-slot { grid-column: 2; grid-row: 3; }
.boots-slot { grid-column: 2; grid-row: 4; }

/* RIGHT PANEL - ACTIONS & GAME INFO */
.right-panel {
    padding: 25px;
    background: var(--bg-panel);
    display: flex;
    flex-direction: column;
    gap: 25px;
}

/* CURRENT RUN SECTION */
.current-run-section {
    background: rgba(0, 0, 0, 0.05);
    padding: 20px;
    border: 2px solid var(--border);
    border-radius: 8px;
}

.run-info {
    background: var(--bg-main);
    padding: 15px;
    border: 2px solid var(--border);
    margin-top: 15px;
}

.monster-display {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border);
}

.monster-image {
    width: 80px;
    height: 80px;
    border: 2px solid var(--border);
    background: var(--red);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: white;
}

.monster-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.monster-stats {
    flex: 1;
}

.hp-bar {
    height: 12px;
    background: rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border);
    margin: 8px 0;
    overflow: hidden;
}

.hp-fill {
    height: 100%;
    background: var(--red);
    transition: width 0.5s ease;
}

.stage-info {
    text-align: center;
    padding: 10px;
    background: var(--bg-main);
    border: 2px solid var(--border);
    margin-top: 15px;
    font-weight: 600;
}

/* GACHA BANNER SECTION */
.gacha-section {
    background: rgba(0, 0, 0, 0.05);
    padding: 20px;
    border: 2px solid var(--border);
    border-radius: 8px;
}

.banner-display {
    background: linear-gradient(135deg, var(--purple), var(--blue));
    padding: 20px;
    border: 2px solid var(--border);
    margin-top: 15px;
    color: white;
    text-align: center;
}

.banner-featured {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin: 15px 0;
}

.featured-item {
    width: 60px;
    height: 60px;
    border: 2px solid var(--yellow);
    background: var(--bg-main);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.featured-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.banner-cost {
    font-size: 24px;
    font-weight: 700;
    color: var(--yellow);
    margin: 10px 0;
}

/* LEADERBOARD PREVIEW */
.leaderboard-preview {
    background: rgba(0, 0, 0, 0.05);
    padding: 20px;
    border: 2px solid var(--border);
    border-radius: 8px;
}

.leaderboard-list {
    margin-top: 15px;
}

.leaderboard-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: var(--bg-main);
    border: 2px solid var(--border);
    margin-bottom: 8px;
    transition: transform 0.2s;
}

.leaderboard-item:hover {
    transform: translateX(5px);
}

.rank {
    width: 30px;
    height: 30px;
    background: var(--accent);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border: 2px solid var(--border);
}

.rank.top { background: var(--yellow); color: var(--accent); }
.rank.top-3 { background: var(--blue); }

/* ACTION MENU */
.action-menu {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: auto;
    padding-top: 25px;
    border-top: 3px solid var(--border);
}

.action-btn {
    background: var(--light-green);
    padding: 20px;
    text-align: center;
    font-weight: bold;
    font-size: 18px;
    border: 3px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.action-btn:hover {
    background: var(--bright-green);
    transform: translateY(-3px);
}

.action-btn i {
    font-size: 32px;
}

.action-btn.play { background: var(--red); color: white; }
.action-btn.play:hover { background: #ff6666; }

.action-btn.gacha { background: var(--yellow); }
.action-btn.gacha:hover { background: #ffed4d; }

.action-btn.inventory { background: var(--blue); color: white; }
.action-btn.inventory:hover { background: #66b3ff; }

.action-btn.settings { background: var(--purple); color: white; }
.action-btn.settings:hover { background: #b366ff; }

/* MODALS */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background-color: var(--bg-main);
    border-radius: 0;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    border: 3px solid var(--border);
}

.modal-header {
    padding: 15px;
    border-bottom: 3px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-panel);
}

.modal-header h3 {
    margin: 0;
    font-size: 1.2rem;
}

.modal-body {
    padding: 20px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--border);
    font-weight: bold;
    transition: color 0.2s;
}

.close-btn:hover {
    color: var(--red);
}

/* INVENTORY MODAL */
.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.inventory-item {
    border: 2px solid var(--border);
    padding: 10px;
    text-align: center;
    background: var(--bg-panel);
    cursor: pointer;
    position: relative;
    transition: all 0.2s;
}

.inventory-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.inventory-item.equipped {
    border-color: var(--green);
    background: rgba(0, 184, 92, 0.1);
}

.item-image {
    width: 60px;
    height: 60px;
    background: var(--yellow);
    margin: 0 auto 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    border: 2px solid var(--border);
}

.item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-actions {
    display: flex;
    gap: 5px;
    margin-top: 8px;
}

/* GACHA MODAL */
.gacha-preview {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, var(--purple), var(--blue));
    color: white;
    margin-bottom: 20px;
}

.pull-animation {
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    background: rgba(0, 0, 0, 0.2);
    margin: 20px 0;
    border: 3px solid var(--border);
}

/* NOTIFICATIONS */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background: var(--green);
    color: white;
    border: 3px solid var(--border);
    font-weight: 600;
    z-index: 1001;
    transform: translateX(400px);
    transition: transform 0.3s ease;
    min-width: 300px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.notification.show {
    transform: translateX(0);
}

.notification.error {
    background: var(--red);
}

.notification.warning {
    background: var(--yellow);
    color: var(--accent);
}

/* LOADING */
.loading {
    text-align: center;
    padding: 40px;
    color: #666;
    font-style: italic;
}

/* LOADING OVERLAY */
#loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    color: white;
    font-size: 24px;
    backdrop-filter: blur(5px);
}

.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--green);
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* TOOLTIP */
.tooltip {
    position: fixed;
    background: var(--accent);
    color: white;
    padding: 10px 15px;
    border: 2px solid var(--border);
    border-radius: 4px;
    font-size: 12px;
    z-index: 1002;
    max-width: 300px;
    pointer-events: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* ITEM COMPARISON */
.item-comparison {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
    padding: 10px;
    background: rgba(0,0,0,0.05);
    border: 1px solid var(--border);
}

.comparison-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.stat-diff {
    font-size: 12px;
    font-weight: bold;
}

.stat-diff.positive {
    color: var(--green);
}

.stat-diff.negative {
    color: var(--red);
}

/* RESPONSIVE */
@media (max-width: 992px) {
    .main-content {
        grid-template-columns: 1fr;
    }
    
    .left-panel {
        border-right: none;
        border-bottom: 3px solid var(--border);
    }
    
    .top-bar {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .currency-display {
        align-items: center;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .action-menu {
        grid-template-columns: 1fr;
    }
    
    .top-bar .quick-actions {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .equipment-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .helmet-slot { grid-column: 1; grid-row: 1; }
    .shield-slot { grid-column: 2; grid-row: 1; }
    .chest-slot { grid-column: 1; grid-row: 2; }
    .weapon-slot { grid-column: 2; grid-row: 2; }
    .legs-slot { grid-column: 1; grid-row: 3; }
    .boots-slot { grid-column: 2; grid-row: 3; }
}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="app">
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="profile">
            <div class="pfp" id="player-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="profile-info">
                <div class="username" id="player-username">-</div>
                <div>HIGH SCORE: <span id="player-highscore">-</span></div>
                <div class="level">LEVEL <span id="player-level">-</span></div>
            </div>
        </div>
        
        <div class="currency-display">
            <div class="gold" id="player-gold">
                <i class="fas fa-coins"></i> GOLD: <span id="gold-amount">-</span>
            </div>
        </div>
        
        <div class="quick-actions">
            <button class="btn btn-success" onclick="startNewRun()">
                <i class="fas fa-play"></i> NEW RUN
            </button>
            <button class="btn btn-warning" onclick="openGachaModal()">
                <i class="fas fa-dice"></i> GACHA
            </button>
            <button class="btn btn-primary" onclick="openInventoryModal()">
                <i class="fas fa-backpack"></i> INVENTORY
            </button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- LEFT PANEL -->
        <div class="left-panel">
            <!-- STATS SECTION -->
            <div class="stats-section">
                <div class="section-title">CHARACTER STATS</div>
                <div class="stats-grid">
                    <div class="stat-card" onclick="showStatDetails('health')">
                        <div class="stat-label">HEALTH</div>
                        <div class="stat-value" id="stat-health">-</div>
                    </div>
                    
                    <div class="stat-card" onclick="showStatDetails('damage')">
                        <div class="stat-label">DAMAGE</div>
                        <div class="stat-value" id="stat-damage">-</div>
                    </div>
                    
                    <div class="stat-card" onclick="showStatDetails('defense')">
                        <div class="stat-label">DEFENSE</div>
                        <div class="stat-value" id="stat-defense">-</div>
                    </div>
                    
                    <div class="stat-card" onclick="showStatDetails('crit')">
                        <div class="stat-label">CRIT CHANCE</div>
                        <div class="stat-value" id="stat-crit">-</div>
                    </div>
                    
                    <div class="health-display">
                        <div class="health-bar">
                            <div class="health-fill" id="health-bar-fill" style="width: 100%"></div>
                        </div>
                        <div class="health-text" id="health-text">- / - HP</div>
                    </div>
                </div>
            </div>

            <!-- EQUIPMENT SECTION -->
            <div class="equipment-section">
                <div class="section-title">EQUIPMENT</div>
                <div class="equipment-grid">
                    <!-- Helmet -->
                    <div class="equipment-slot helmet-slot empty" onclick="equipSlot('helmet')" id="slot-helmet">
                        <div class="equipment-icon">
                            <i class="fas fa-helmet-battle"></i>
                        </div>
                        <div class="slot-name">HELMET</div>
                        <div class="item-name" id="item-helmet">-</div>
                    </div>
                    
                    <!-- Shield -->
                    <div class="equipment-slot shield-slot empty" onclick="equipSlot('shield')" id="slot-shield">
                        <div class="equipment-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="slot-name">SHIELD</div>
                        <div class="item-name" id="item-shield">-</div>
                    </div>
                    
                    <!-- Chest -->
                    <div class="equipment-slot chest-slot empty" onclick="equipSlot('chest')" id="slot-chest">
                        <div class="equipment-icon">
                            <i class="fas fa-vest"></i>
                        </div>
                        <div class="slot-name">CHESTPLATE</div>
                        <div class="item-name" id="item-chest">-</div>
                    </div>
                    
                    <!-- Weapon -->
                    <div class="equipment-slot weapon-slot empty" onclick="equipSlot('weapon')" id="slot-weapon">
                        <div class="equipment-icon">
                            <i class="fas fa-sword"></i>
                        </div>
                        <div class="slot-name">WEAPON</div>
                        <div class="item-name" id="item-weapon">-</div>
                    </div>
                    
                    <!-- Legs -->
                    <div class="equipment-slot legs-slot empty" onclick="equipSlot('legs')" id="slot-legs">
                        <div class="equipment-icon">
                            <i class="fas fa-running"></i>
                        </div>
                        <div class="slot-name">LEGGINGS</div>
                        <div class="item-name" id="item-legs">-</div>
                    </div>
                    
                    <!-- Boots -->
                    <div class="equipment-slot boots-slot empty" onclick="equipSlot('boots')" id="slot-boots">
                        <div class="equipment-icon">
                            <i class="fas fa-boot"></i>
                        </div>
                        <div class="slot-name">BOOTS</div>
                        <div class="item-name" id="item-boots">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="right-panel">
            <!-- CURRENT RUN SECTION -->
            <div class="current-run-section">
                <div class="section-title">CURRENT RUN</div>
                <div class="run-info" id="current-run-info">
                    <div class="loading">-</div>
                </div>
            </div>

            <!-- GACHA BANNER SECTION -->
            <div class="gacha-section">
                <div class="section-title">ACTIVE BANNER</div>
                <div class="banner-display" id="active-banner">
                    <div class="loading">-</div>
                </div>
            </div>

            <!-- LEADERBOARD PREVIEW -->
            <div class="leaderboard-preview">
                <div class="section-title">LEADERBOARD</div>
                <div class="leaderboard-list" id="leaderboard-preview">
                    <div class="loading">-</div>
                </div>
            </div>

            <!-- ACTION MENU -->
            <div class="action-menu">
                <button class="action-btn play" onclick="continueRun()">
                    <i class="fas fa-play-circle"></i>
                    <span>CONTINUE</span>
                </button>
                <button class="action-btn gacha" onclick="openGachaModal()">
                    <i class="fas fa-dice"></i>
                    <span>GACHA</span>
                </button>
                <button class="action-btn inventory" onclick="openInventoryModal()">
                    <i class="fas fa-backpack"></i>
                    <span>INVENTORY</span>
                </button>
                <button class="action-btn settings" onclick="openSettingsModal()">
                    <i class="fas fa-cog"></i>
                    <span>SETTINGS</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<!-- INVENTORY MODAL -->
<div class="modal" id="inventory-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>INVENTORY</h3>
            <button class="close-btn" onclick="closeInventoryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="inventory-grid" id="inventory-items">
                <div class="loading">-</div>
            </div>
        </div>
    </div>
</div>

<!-- GACHA MODAL -->
<div class="modal" id="gacha-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>GACHA SYSTEM</h3>
            <button class="close-btn" onclick="closeGachaModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="gacha-content">
                <div class="loading">-</div>
            </div>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>SETTINGS</h3>
            <button class="close-btn" onclick="closeSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 40px;">
                <h4>Game Settings</h4>
                <p>Audio, graphics, and gameplay options would go here.</p>
                <button class="btn btn-warning" style="margin-top: 20px;" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> LOGOUT
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ERROR MODAL -->
<div class="modal" id="error-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--red);">ERROR</h3>
            <button class="close-btn" onclick="closeErrorModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: var(--red); margin-bottom: 20px;"></i>
                <h4 id="error-title">Game Setup Required</h4>
                <p id="error-message">No game data found. Please set up the game first.</p>
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="goToAdmin()">
                        <i class="fas fa-cog"></i> GO TO ADMIN PANEL
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NOTIFICATION -->
<div class="notification" id="notification"></div>

<!-- LOADING OVERLAY -->
<div id="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <div id="loading-text">Loading...</div>
</div>

<!-- TOOLTIP -->
<div class="tooltip" id="tooltip" style="display: none;"></div>

<script type="module">
// Import Supabase client from external file
import { supabase } from './supabase.js';

console.log('RPG Lobby - Supabase client loaded from external file');

// Global variables
let currentUser = null;
let playerStats = null;
let playerEquipment = [];
let equippedItems = {};
let currentRun = null;
let inventoryItems = [];
let gachaBanners = [];
let leaderboardData = [];
let isLoading = false;

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', async () => {
    console.log('Initializing RPG Lobby...');
    
    // Check if supabase is available
    if (!supabase) {
        console.error('Supabase client not available from supabase.js');
        showError('Supabase Error', 'Failed to initialize Supabase client. Please check your supabase.js file.');
        return;
    }
    
    await withLoading(async () => {
        await loadPlayerData();
        await loadCurrentRun();
        await loadGachaBanners();
        await loadLeaderboard();
        updateUI();
    });
    
    // Auto-refresh every 30 seconds
    setInterval(async () => {
        await refreshData();
    }, 30000);
});

// Loading wrapper
async function withLoading(fn) {
    if (isLoading) return;
    isLoading = true;
    
    const overlay = document.getElementById('loading-overlay');
    overlay.style.display = 'flex';
    
    try {
        await fn();
    } catch (error) {
        console.error('Error in loading operation:', error);
        showNotification('Operation failed: ' + error.message, 'error');
    } finally {
        isLoading = false;
        overlay.style.display = 'none';
    }
}

// Load player data from database - FIXED VERSION
async function loadPlayerData() {
    if (!supabase) {
        showNotification('Database not configured', 'error');
        return;
    }
    
    try {
        // Get current user
        const { data: users, error: usersError } = await supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: true })
            .limit(1);
        
        if (usersError) {
            console.error('Error loading user:', usersError);
            showError('Database Error', 'Could not load user data. Please check database connection.');
            return;
        }
        
        if (!users || users.length === 0) {
            showError('No User Found', 'Please create a user in the admin panel first.');
            return;
        }
        
        currentUser = users[0];
        console.log('Current user loaded:', currentUser);
        updatePlayerAvatar();
        
        // Update player info
        document.getElementById('player-username').textContent = currentUser.username || '-';
        document.getElementById('player-highscore').textContent = currentUser.highest_stage || '-';
        document.getElementById('gold-amount').textContent = currentUser.gold || '-';
        
        // Get player stats
        const { data: stats, error: statsError } = await supabase
            .from('player_stats')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();
        
        if (statsError) {
            console.error('Error loading player stats:', statsError);
            // Don't show error, just create default stats
            playerStats = {
                base_hp: 100,
                base_damage: 10,
                base_defense: 5,
                crit_chance: 0.05
            };
        } else if (stats) {
            playerStats = stats;
        } else {
            // Create default stats if none exist
            playerStats = {
                base_hp: 100,
                base_damage: 10,
                base_defense: 5,
                crit_chance: 0.05
            };
        }
        
        // Get player equipment - FIXED QUERY BASED ON YOUR SCHEMA
        console.log('Fetching player equipment for user:', currentUser.id);
        const { data: playerEquipmentData, error: playerEquipmentError } = await supabase
            .from('player_equipment')
            .select('*')
            .eq('user_id', currentUser.id);
        
        if (playerEquipmentError) {
            console.error('Error loading player equipment:', playerEquipmentError);
            console.error('Error details:', playerEquipmentError.message);
            playerEquipment = [];
        } else {
            playerEquipment = playerEquipmentData || [];
            console.log('Raw player equipment data:', playerEquipment);
            
            // Get all equipment details for the items
            if (playerEquipment.length > 0) {
                const equipmentIds = playerEquipment.map(item => item.equipment_id).filter(id => id);
                console.log('Equipment IDs to fetch:', equipmentIds);
                
                if (equipmentIds.length > 0) {
                    const { data: equipmentDetails, error: equipmentDetailsError } = await supabase
                        .from('equipment')
                        .select('*')
                        .in('id', equipmentIds);
                    
                    if (!equipmentDetailsError && equipmentDetails) {
                        console.log('Equipment details fetched:', equipmentDetails);
                        
                        // Map equipment details to player equipment
                        playerEquipment = playerEquipment.map(playerItem => {
                            const detail = equipmentDetails.find(e => e.id === playerItem.equipment_id);
                            return {
                                ...playerItem,
                                equipment: detail || null
                            };
                        });
                    } else if (equipmentDetailsError) {
                        console.error('Error fetching equipment details:', equipmentDetailsError);
                    }
                }
            }
            
            console.log('Processed player equipment:', playerEquipment);
            
            // Organize equipped items
            equippedItems = {};
            playerEquipment.forEach(item => {
                if (item && item.equipment && item.is_equipped) {
                    const slot = item.equipment.slot ? item.equipment.slot.toLowerCase() : 'weapon';
                    equippedItems[slot] = {
                        ...item.equipment,
                        player_equipment_id: item.id,
                        is_equipped: true
                    };
                    console.log(`Equipped item in slot ${slot}:`, item.equipment.name);
                }
            });
            
            console.log('Equipped items:', equippedItems);
            
            // All items for inventory
            inventoryItems = playerEquipment
                .filter(item => item && item.equipment)
                .map(item => ({
                    ...item.equipment,
                    player_equipment_id: item.id,
                    is_equipped: item.is_equipped,
                    player_equipment_data: item
                }));
            
            console.log('Inventory items:', inventoryItems);
        }
        
        console.log('Player data loaded successfully');
        
    } catch (error) {
        console.error('Error loading player data:', error);
        showError('Game Error', 'Failed to load player data. Please try again.');
    }
}

// Update player avatar
function updatePlayerAvatar() {
    const pfp = document.getElementById('player-avatar');
    const username = currentUser?.username || 'Player';
    const initials = username.substring(0, 2).toUpperCase();
    
    // Generate a consistent color based on username
    const colors = ['#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F'];
    const colorIndex = username.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length;
    
    pfp.style.backgroundColor = colors[colorIndex];
    pfp.innerHTML = `<span style="font-size: 20px; font-weight: bold;">${initials}</span>`;
}

// Load current active run
async function loadCurrentRun() {
    try {
        if (!currentUser) return;
        
        // First, get the run without the join
        const { data: runs, error } = await supabase
            .from('runs')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false })
            .limit(1);
        
        if (error) {
            console.error('Error loading run:', error);
            return;
        }
        
        if (runs && runs.length > 0) {
            currentRun = runs[0];
            
            // Then get the monster separately if it exists
            if (currentRun.current_monster) {
                const { data: monster, error: monsterError } = await supabase
                    .from('monsters')
                    .select('*')
                    .eq('id', currentRun.current_monster)
                    .single();
                
                if (!monsterError && monster) {
                    currentRun.monster = monster;
                }
            }
            
            updateRunDisplay();
        } else {
            currentRun = null;
            document.getElementById('current-run-info').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h4>No Active Run</h4>
                    <p>Start a new adventure!</p>
                    <button class="btn btn-success" onclick="startNewRun()" style="margin-top: 10px;">
                        <i class="fas fa-play"></i> START NEW RUN
                    </button>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading current run:', error);
        document.getElementById('current-run-info').innerHTML = `
            <div class="loading">-</div>
        `;
    }
}

// Load gacha banners
async function loadGachaBanners() {
    try {
        // First get banners
        const { data: banners, error } = await supabase
            .from('gacha_banners')
            .select('*')
            .eq('is_active', true)
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error loading gacha banner:', error);
            return;
        }
        
        gachaBanners = banners || [];
        
        // Then get rates for each banner
        for (let banner of gachaBanners) {
            const { data: rates, error: ratesError } = await supabase
                .from('gacha_rates')
                .select('*')
                .eq('banner_id', banner.id);
            
            if (!ratesError) {
                banner.gacha_rate = rates || [];
            }
        }
        
        if (gachaBanners.length > 0) {
            updateBannerDisplay();
        } else {
            document.getElementById('active-banner').innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h4>No Active Banners</h4>
                    <p>Check back later for new banners!</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('Error loading gacha banners:', error);
        document.getElementById('active-banner').innerHTML = `
            <div class="loading">-</div>
        `;
    }
}

// Load leaderboard
async function loadLeaderboard() {
    try {
        // First get leaderboard entries
        const { data: leaderboard, error } = await supabase
            .from('leaderboard')
            .select('*')
            .order('highest_stage', { ascending: false })
            .order('monsters_defeated', { ascending: false })
            .limit(5);
        
        if (error) {
            console.error('Error loading leaderboard:', error);
            return;
        }
        
        leaderboardData = leaderboard || [];
        
        // Get user data for each leaderboard entry
        for (let entry of leaderboardData) {
            const { data: user, error: userError } = await supabase
                .from('users')
                .select('username')
                .eq('id', entry.user_id)
                .single();
            
            if (!userError) {
                entry.user = user;
            }
        }
        
        updateLeaderboardDisplay();
        
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        document.getElementById('leaderboard-preview').innerHTML = `
            <div class="loading">-</div>
        `;
    }
}

// Update UI with loaded data
function updateUI() {
    // Update player stats
    if (playerStats) {
        const baseHP = playerStats.base_hp || 100;
        const baseDamage = playerStats.base_damage || 10;
        const baseDefense = playerStats.base_defense || 5;
        const critChance = playerStats.crit_chance || 0.05;
        
        // Calculate bonuses from equipped items
        let hpBonus = 0;
        let damageBonus = 0;
        let defenseBonus = 0;
        let critBonus = 0;
        
        Object.values(equippedItems).forEach(item => {
            if (item) {
                hpBonus += item.health_bonus || 0;
                damageBonus += item.damage || 0;
                defenseBonus += item.defense || 0;
                critBonus += item.crit_bonus || 0;
            }
        });
        
        const totalHP = baseHP + hpBonus;
        const totalDamage = baseDamage + damageBonus;
        const totalDefense = baseDefense + defenseBonus;
        const totalCrit = critChance + critBonus;
        
        document.getElementById('stat-health').textContent = totalHP;
        document.getElementById('stat-damage').textContent = totalDamage;
        document.getElementById('stat-defense').textContent = totalDefense;
        document.getElementById('stat-crit').textContent = `${(totalCrit * 100).toFixed(1)}%`;
        
        // Update health bar
        const healthPercent = currentRun ? (currentRun.player_hp / totalHP * 100) : 100;
        document.getElementById('health-bar-fill').style.width = `${Math.max(0, healthPercent)}%`;
        document.getElementById('health-text').textContent = currentRun ? 
            `${Math.max(0, currentRun.player_hp)} / ${totalHP} HP` : 
            `${totalHP} / ${totalHP} HP`;
        
        // Calculate player level (simplified based on stats)
        const level = Math.floor((totalHP + totalDamage * 10 + totalDefense * 5) / 100) + 1;
        document.getElementById('player-level').textContent = level;
    }
    
    // Update equipment slots
    const slots = ['helmet', 'shield', 'chest', 'weapon', 'legs', 'boots'];
    slots.forEach(slot => {
        const element = document.getElementById(`slot-${slot}`);
        const itemName = document.getElementById(`item-${slot}`);
        
        if (equippedItems[slot]) {
            const item = equippedItems[slot];
            element.classList.remove('empty');
            itemName.textContent = item.name || '-';
            
            // Add rarity badge
            const existingRarity = element.querySelector('.item-rarity');
            if (existingRarity) existingRarity.remove();
            
            const rarityDiv = document.createElement('div');
            rarityDiv.className = `item-rarity rarity-${item.rarity || 'common'}`;
            rarityDiv.textContent = item.rarity?.charAt(0).toUpperCase() || 'C';
            element.appendChild(rarityDiv);
            
            // Add image if available
            const icon = element.querySelector('.equipment-icon');
            if (item.image_url) {
                icon.innerHTML = `<img src="${item.image_url}" alt="${item.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-question\\'></i>'">`;
            } else {
                const iconClass = {
                    helmet: 'fa-helmet-battle',
                    shield: 'fa-shield-alt',
                    chest: 'fa-vest',
                    weapon: 'fa-sword',
                    legs: 'fa-running',
                    boots: 'fa-boot'
                }[slot];
                icon.innerHTML = `<i class="fas ${iconClass}"></i>`;
            }
        } else {
            element.classList.add('empty');
            itemName.textContent = '-';
            
            // Reset icon
            const icon = element.querySelector('.equipment-icon');
            const iconClass = {
                helmet: 'fa-helmet-battle',
                shield: 'fa-shield-alt',
                chest: 'fa-vest',
                weapon: 'fa-sword',
                legs: 'fa-running',
                boots: 'fa-boot'
            }[slot];
            icon.innerHTML = `<i class="fas ${iconClass}"></i>`;
            
            // Remove rarity badge
            const existingRarity = element.querySelector('.item-rarity');
            if (existingRarity) existingRarity.remove();
        }
    });
}

// Update run display
function updateRunDisplay() {
    if (!currentRun) return;
    
    const runInfo = document.getElementById('current-run-info');
    const monster = currentRun.monster;
    
    let monsterHTML = '';
    if (monster) {
        const monsterHPPercent = Math.max(0, (currentRun.monster_hp / monster.hp * 100));
        
        monsterHTML = `
            <div class="monster-display">
                <div class="monster-image">
                    ${monster.image_url ? 
                        `<img src="${monster.image_url}" alt="${monster.name}" onerror="this.innerHTML='<i class=\\'fas fa-dragon\\'></i>'">` : 
                        `<i class="fas fa-dragon"></i>`
                    }
                </div>
                <div class="monster-stats">
                    <h4>${monster.name}</h4>
                    <div>Stage ${currentRun.current_stage}</div>
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: ${monsterHPPercent}%"></div>
                    </div>
                    <div>HP: ${Math.max(0, currentRun.monster_hp)} / ${monster.hp}</div>
                    <div>Category: ${monster.category || '-'}</div>
                    <div style="font-size: 12px; color: #666;">
                        Gold Reward: ${monster.gold_reward || 0} <i class="fas fa-coins"></i>
                    </div>
                </div>
            </div>
        `;
    }
    
    runInfo.innerHTML = `
        ${monsterHTML}
        <div class="stage-info">
            Stage ${currentRun.current_stage} | Streak: ${currentRun.streak || 0}
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-success" onclick="continueRun()">
                <i class="fas fa-play"></i> CONTINUE
            </button>
            <button class="btn btn-warning" onclick="abandonRun()">
                <i class="fas fa-times"></i> ABANDON
            </button>
        </div>
    `;
}

// Update banner display
function updateBannerDisplay() {
    if (gachaBanners.length === 0) return;
    
    const banner = gachaBanners[0];
    const bannerDiv = document.getElementById('active-banner');
    
    // Get featured items from rates (simplified)
    const featuredRates = banner.gacha_rate?.filter(rate => 
        ['epic', 'legendary'].includes(rate.rarity?.toLowerCase())
    ) || [];
    
    let featuredHTML = '';
    if (featuredRates.length > 0) {
        featuredHTML = `
            <div class="banner-featured">
                ${featuredRates.slice(0, 3).map((rate, i) => `
                    <div class="featured-item">
                        <i class="fas fa-star" style="color: ${rate.rarity === 'legendary' ? 'var(--orange)' : 'var(--purple)'}"></i>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    const canAfford = currentUser && currentUser.gold >= banner.cost;
    const canAffordMulti = currentUser && currentUser.gold >= (banner.cost * 10);
    
    bannerDiv.innerHTML = `
        <h4>${banner.name}</h4>
        ${featuredHTML}
        <div class="banner-cost">
            <i class="fas fa-coins"></i> ${banner.cost} GOLD
        </div>
        <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: center;">
            <button class="btn ${canAfford ? 'btn-warning' : ''}" 
                    onclick="pullGacha('${banner.id}')" 
                    ${!canAfford ? 'disabled style="opacity: 0.5;"' : ''}>
                <i class="fas fa-dice"></i> PULL ONCE
            </button>
            <button class="btn ${canAffordMulti ? 'btn-primary' : ''}" 
                    onclick="pullGachaMulti('${banner.id}')" 
                    ${!canAffordMulti ? 'disabled style="opacity: 0.5;"' : ''}>
                <i class="fas fa-dice-five"></i> 10-PULL
            </button>
        </div>
        ${!canAfford ? '<div style="margin-top: 10px; font-size: 12px; color: var(--yellow);">Not enough gold!</div>' : ''}
    `;
}

// Update leaderboard display
function updateLeaderboardDisplay() {
    const leaderboardDiv = document.getElementById('leaderboard-preview');
    
    if (leaderboardData.length === 0) {
        leaderboardDiv.innerHTML = '<div class="loading">-</div>';
        return;
    }
    
    let html = '';
    leaderboardData.forEach((entry, index) => {
        const rankClass = index === 0 ? 'top' : index < 3 ? 'top-3' : '';
        const isCurrentUser = currentUser && entry.user_id === currentUser.id;
        const username = entry.user?.username || 'Unknown';
        
        html += `
            <div class="leaderboard-item" style="${isCurrentUser ? 'border-color: var(--green); background: rgba(0,184,92,0.1);' : ''}">
                <div class="rank ${rankClass}">${index + 1}</div>
                <div style="flex: 1;">
                    <strong>${username}</strong>
                    ${isCurrentUser ? ' <span style="color: var(--green); font-size: 10px;">(YOU)</span>' : ''}
                    <div style="font-size: 12px;">
                        Stage ${entry.highest_stage || 0} | ${entry.monsters_defeated || 0} kills
                    </div>
                </div>
                <div style="font-weight: 700; color: var(--green);">
                    ${entry.correct_answers || 0}
                </div>
            </div>
        `;
    });
    
    leaderboardDiv.innerHTML = html;
}

// Open inventory modal
async function openInventoryModal() {
    const modal = document.getElementById('inventory-modal');
    const itemsDiv = document.getElementById('inventory-items');
    
    // Refresh inventory data first
    await loadPlayerData();
    
    if (!inventoryItems || inventoryItems.length === 0) {
        itemsDiv.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <h4>No Items</h4>
                <p>Your inventory is empty. Try the gacha system!</p>
                <button class="btn btn-warning" onclick="openGachaModal()" style="margin-top: 10px;">
                    <i class="fas fa-dice"></i> GO TO GACHA
                </button>
            </div>
        `;
    } else {
        let html = '';
        inventoryItems.forEach(item => {
            if (!item) return;
            
            const isEquipped = item.is_equipped;
            const slot = item.slot?.toLowerCase();
            const equippedClass = isEquipped ? 'equipped' : '';
            const equippedItem = equippedItems[slot];
            
            html += `
                <div class="inventory-item ${equippedClass}" 
                     onclick="selectInventoryItem('${item.id}')" 
                     data-id="${item.id}"
                     onmouseenter="showItemTooltip(event, '${item.id}')"
                     onmouseleave="hideTooltip()">
                    <div class="item-image">
                        ${item.image_url ? 
                            `<img src="${item.image_url}" alt="${item.name}" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-question\\'></i>'">` : 
                            `<i class="fas fa-question"></i>`
                        }
                    </div>
                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 5px;">${item.name || '-'}</div>
                    <div style="font-size: 10px; color: #666; margin-bottom: 5px;">${item.slot || '-'}</div>
                    <div class="item-rarity rarity-${item.rarity || 'common'}" style="margin-bottom: 5px;">
                        ${item.rarity?.toUpperCase() || 'COMMON'}
                    </div>
                    <div class="item-actions">
                        ${!isEquipped ? `
                            <button class="btn" onclick="event.stopPropagation(); equipItem('${item.player_equipment_id}', '${slot}')" style="font-size: 10px; padding: 4px 8px;">
                                EQUIP
                            </button>
                        ` : `
                            <button class="btn" onclick="event.stopPropagation(); unequipItem('${item.player_equipment_id}')" style="font-size: 10px; padding: 4px 8px;">
                                UNEQUIP
                            </button>
                        `}
                    </div>
                </div>
            `;
        });
        
        itemsDiv.innerHTML = html;
    }
    
    modal.classList.add('active');
}

// Show item tooltip
function showItemTooltip(event, itemId) {
    const item = inventoryItems.find(i => i && i.id === itemId);
    if (!item) return;
    
    const tooltip = document.getElementById('tooltip');
    const equippedItem = equippedItems[item.slot?.toLowerCase()];
    
    let html = `<strong>${item.name || 'Unknown Item'}</strong><br>`;
    html += `<small>${item.rarity || 'common'} ${item.slot || 'unknown'}</small><br>`;
    
    if (item.damage) html += `Damage: ${item.damage}<br>`;
    if (item.defense) html += `Defense: ${item.defense}<br>`;
    if (item.health_bonus) html += `HP Bonus: ${item.health_bonus}<br>`;
    if (item.crit_bonus) html += `Crit Bonus: ${(item.crit_bonus * 100).toFixed(1)}%<br>`;
    
    if (equippedItem && equippedItem.id !== item.id) {
        html += `<hr><small>Currently Equipped:</small><br>`;
        html += `<strong>${equippedItem.name || 'Unknown Item'}</strong><br>`;
        if (equippedItem.damage) html += `Damage: ${equippedItem.damage}<br>`;
        if (equippedItem.defense) html += `Defense: ${equippedItem.defense}<br>`;
        
        // Show comparison
        const damageDiff = (item.damage || 0) - (equippedItem.damage || 0);
        const defenseDiff = (item.defense || 0) - (equippedItem.defense || 0);
        const hpDiff = (item.health_bonus || 0) - (equippedItem.health_bonus || 0);
        const critDiff = (item.crit_bonus || 0) - (equippedItem.crit_bonus || 0);
        
        if (damageDiff !== 0) html += `<span class="stat-diff ${damageDiff > 0 ? 'positive' : 'negative'}">${damageDiff > 0 ? '+' : ''}${damageDiff} damage</span><br>`;
        if (defenseDiff !== 0) html += `<span class="stat-diff ${defenseDiff > 0 ? 'positive' : 'negative'}">${defenseDiff > 0 ? '+' : ''}${defenseDiff} defense</span><br>`;
        if (hpDiff !== 0) html += `<span class="stat-diff ${hpDiff > 0 ? 'positive' : 'negative'}">${hpDiff > 0 ? '+' : ''}${hpDiff} HP</span><br>`;
        if (critDiff !== 0) html += `<span class="stat-diff ${critDiff > 0 ? 'positive' : 'negative'}">${critDiff > 0 ? '+' : ''}${(critDiff * 100).toFixed(1)}% crit</span><br>`;
    }
    
    tooltip.innerHTML = html;
    tooltip.style.display = 'block';
    tooltip.style.left = (event.pageX + 10) + 'px';
    tooltip.style.top = (event.pageY + 10) + 'px';
}

// Hide tooltip
function hideTooltip() {
    document.getElementById('tooltip').style.display = 'none';
}

// Show stat details
function showStatDetails(stat) {
    let message = '';
    switch(stat) {
        case 'health':
            message = 'Health determines how much damage you can take before your run ends.';
            break;
        case 'damage':
            message = 'Damage determines how much health you remove from monsters with correct answers.';
            break;
        case 'defense':
            message = 'Defense reduces the damage you take from incorrect answers.';
            break;
        case 'crit':
            message = 'Critical chance is the probability of dealing double damage.';
            break;
    }
    
    if (playerStats) {
        const baseHP = playerStats.base_hp || 100;
        const baseDamage = playerStats.base_damage || 10;
        const baseDefense = playerStats.base_defense || 5;
        const critChance = playerStats.crit_chance || 0.05;
        
        let hpBonus = 0, damageBonus = 0, defenseBonus = 0, critBonus = 0;
        
        Object.values(equippedItems).forEach(item => {
            if (item) {
                hpBonus += item.health_bonus || 0;
                damageBonus += item.damage || 0;
                defenseBonus += item.defense || 0;
                critBonus += item.crit_bonus || 0;
            }
        });
        
        message += '\n\nBase Stats:\n';
        message += `- Health: ${baseHP}\n`;
        message += `- Damage: ${baseDamage}\n`;
        message += `- Defense: ${baseDefense}\n`;
        message += `- Crit: ${(critChance * 100).toFixed(1)}%\n`;
        
        if (hpBonus > 0 || damageBonus > 0 || defenseBonus > 0 || critBonus > 0) {
            message += '\nEquipment Bonuses:\n';
            if (hpBonus > 0) message += `- Health: +${hpBonus}\n`;
            if (damageBonus > 0) message += `- Damage: +${damageBonus}\n`;
            if (defenseBonus > 0) message += `- Defense: +${defenseBonus}\n`;
            if (critBonus > 0) message += `- Crit: +${(critBonus * 100).toFixed(1)}%\n`;
        }
    }
    
    alert(message);
}

// Close inventory modal
function closeInventoryModal() {
    document.getElementById('inventory-modal').classList.remove('active');
}

// Open gacha modal
async function openGachaModal() {
    const modal = document.getElementById('gacha-modal');
    const contentDiv = document.getElementById('gacha-content');
    
    // Refresh gacha data first
    await loadGachaBanners();
    
    if (gachaBanners.length === 0) {
        contentDiv.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <h4>No Active Banners</h4>
                <p>Check back later for gacha banners!</p>
            </div>
        `;
    } else {
        let bannersHTML = '';
        for (let banner of gachaBanners) {
            const rates = banner.gacha_rate || [];
            let ratesHTML = '';
            
            if (rates.length > 0) {
                rates.forEach(rate => {
                    if (!rate) return;
                    ratesHTML += `
                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.3);">
                            <span style="text-transform: capitalize;">${rate.rarity || 'common'}</span>
                            <span>${rate.chance || 0}%</span>
                        </div>
                    `;
                });
            }
            
            const canAfford = currentUser && currentUser.gold >= banner.cost;
            const canAffordMulti = currentUser && currentUser.gold >= (banner.cost * 10);
            
            bannersHTML += `
                <div style="border: 2px solid var(--border); padding: 15px; margin-bottom: 15px; background: linear-gradient(135deg, var(--purple), var(--blue)); color: white;">
                    <h4>${banner.name || 'Unnamed Banner'}</h4>
                    <div style="font-size: 24px; font-weight: 700; color: var(--yellow); margin: 10px 0;">
                        <i class="fas fa-coins"></i> ${banner.cost || 0} GOLD
                    </div>
                    <div style="background: rgba(0, 0, 0, 0.2); padding: 10px; margin: 10px 0; border-radius: 5px;">
                        <h5 style="margin-top: 0;">Drop Rates</h5>
                        ${ratesHTML || '<div style="text-align: center; padding: 10px;">No rates defined</div>'}
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn ${canAfford ? 'btn-warning' : ''}" 
                                onclick="pullGacha('${banner.id}')" 
                                ${!canAfford ? 'disabled style="opacity: 0.5;"' : ''}
                                style="flex: 1;">
                            <i class="fas fa-dice"></i> SINGLE PULL
                        </button>
                        <button class="btn ${canAffordMulti ? 'btn-primary' : ''}" 
                                onclick="pullGachaMulti('${banner.id}')" 
                                ${!canAffordMulti ? 'disabled style="opacity: 0.5;"' : ''}
                                style="flex: 1;">
                            <i class="fas fa-dice-five"></i> 10-PULL
                        </button>
                    </div>
                </div>
            `;
        }
        
        contentDiv.innerHTML = bannersHTML;
    }
    
    modal.classList.add('active');
}

// Close gacha modal
function closeGachaModal() {
    document.getElementById('gacha-modal').classList.remove('active');
}

// Open settings modal
function openSettingsModal() {
    document.getElementById('settings-modal').classList.add('active');
}

// Close settings modal
function closeSettingsModal() {
    document.getElementById('settings-modal').classList.remove('active');
}

// Show error modal
function showError(title, message) {
    document.getElementById('error-title').textContent = title;
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-modal').classList.add('active');
}

// Close error modal
function closeErrorModal() {
    document.getElementById('error-modal').classList.remove('active');
}

// Go to admin panel
function goToAdmin() {
    window.location.href = 'adminside.html';
}

// Equip item
async function equipItem(playerEquipmentId, slot) {
    try {
        if (!currentUser) return;
        
        await withLoading(async () => {
            // First, unequip any item in that slot
            const itemsInSlot = playerEquipment.filter(item => 
                item && item.is_equipped && item.equipment?.slot?.toLowerCase() === slot
            );
            
            for (const item of itemsInSlot) {
                const { error: unequipError } = await supabase
                    .from('player_equipment')
                    .update({ is_equipped: false })
                    .eq('id', item.id);
                
                if (unequipError) throw unequipError;
            }
            
            // Equip the new item
            const { error: equipError } = await supabase
                .from('player_equipment')
                .update({ is_equipped: true })
                .eq('id', playerEquipmentId)
                .eq('user_id', currentUser.id);
            
            if (equipError) throw equipError;
            
            showNotification('Item equipped successfully!', 'success');
            await refreshData();
            
            // Close inventory if open
            closeInventoryModal();
        });
        
    } catch (error) {
        console.error('Error equipping item:', error);
        showNotification('Error equipping item: ' + error.message, 'error');
    }
}

// Unequip item
async function unequipItem(playerEquipmentId) {
    try {
        if (!currentUser) return;
        
        await withLoading(async () => {
            const { error } = await supabase
                .from('player_equipment')
                .update({ is_equipped: false })
                .eq('id', playerEquipmentId)
                .eq('user_id', currentUser.id);
            
            if (error) throw error;
            
            showNotification('Item unequipped', 'success');
            await refreshData();
        });
        
    } catch (error) {
        console.error('Error unequipping item:', error);
        showNotification('Error unequipping item: ' + error.message, 'error');
    }
}

// Select inventory item
function selectInventoryItem(itemId) {
    const item = inventoryItems.find(i => i && i.id === itemId);
    if (!item) return;
    
    let details = `Item Details:\n\nName: ${item.name || 'Unknown'}\nSlot: ${item.slot || 'Unknown'}\nRarity: ${item.rarity || 'common'}`;
    if (item.damage) details += `\nDamage: ${item.damage}`;
    if (item.defense) details += `\nDefense: ${item.defense}`;
    if (item.health_bonus) details += `\nHP Bonus: ${item.health_bonus}`;
    if (item.crit_bonus) details += `\nCrit Bonus: ${(item.crit_bonus * 100).toFixed(1)}%`;
    if (item.created_at) details += `\nObtained: ${new Date(item.created_at).toLocaleDateString()}`;
    
    alert(details);
}

// Equip slot click
function equipSlot(slot) {
    if (equippedItems[slot]) {
        // Show equipped item details
        const item = equippedItems[slot];
        let details = `Equipped ${slot}:\n\n${item.name || 'Unknown'}\nRarity: ${item.rarity || 'common'}`;
        if (item.damage) details += `\nDamage: ${item.damage}`;
        if (item.defense) details += `\nDefense: ${item.defense}`;
        if (item.health_bonus) details += `\nHP Bonus: ${item.health_bonus}`;
        if (item.crit_bonus) details += `\nCrit Bonus: ${(item.crit_bonus * 100).toFixed(1)}%`;
        
        details += `\n\nClick "Inventory" to manage items.`;
        alert(details);
    } else {
        // Open inventory to equip
        openInventoryModal();
    }
}

// Start new run - UPDATED TO REDIRECT TO GAME.HTML IMMEDIATELY
async function startNewRun() {
    try {
        if (!currentUser) return;
        
        await withLoading(async () => {
            // Get first monster for stage 1
            const { data: monsters, error: monstersError } = await supabase
                .from('monsters')
                .select('*')
                .eq('stage', 1)
                .limit(1);
            
            if (monstersError) throw monstersError;
            
            if (!monsters || monsters.length === 0) {
                showNotification('No monsters found for stage 1', 'error');
                return;
            }
            
            const monster = monsters[0];
            const baseHP = playerStats?.base_hp || 100;
            
            // Calculate HP bonuses from equipped items
            let hpBonus = 0;
            Object.values(equippedItems).forEach(item => {
                if (item) {
                    hpBonus += item.health_bonus || 0;
                }
            });
            
            const playerHP = baseHP + hpBonus;
            
            // Create new run
            const { data: run, error: runError } = await supabase
                .from('runs')
                .insert([{
                    user_id: currentUser.id,
                    current_stage: 1,
                    current_monster: monster.id,
                    player_hp: playerHP,
                    monster_hp: monster.hp,
                    streak: 0,
                    started_at: new Date().toISOString()
                }])
                .select('*')
                .single();
            
            if (runError) throw runError;
            
            // Get the monster data for the run
            const { data: monsterData, error: monsterDataError } = await supabase
                .from('monsters')
                .select('*')
                .eq('id', monster.id)
                .single();
            
            if (!monsterDataError) {
                run.monster = monsterData;
            }
            
            currentRun = run;
            showNotification('New run started! Redirecting to game...', 'success');
            
            // REDIRECT IMMEDIATELY TO GAME.HTML WITH THE NEW RUN ID
            setTimeout(() => {
                window.location.href = `game.html?runId=${run.id}`;
            }, 1000);
            
        });
        
    } catch (error) {
        console.error('Error starting new run:', error);
        showNotification('Error starting run: ' + error.message, 'error');
    }
}

// Continue run - UPDATED TO REDIRECT TO GAME.HTML
function continueRun() {
    if (!currentRun) {
        showNotification('No active run. Start a new one!', 'warning');
        return;
    }
    
    // Redirect to game.html with the run ID
    if (currentRun && currentRun.id) {
        window.location.href = `game.html?runId=${currentRun.id}`;
    } else {
        showNotification('No active run found. Starting new run...', 'warning');
        startNewRun();
    }
}

// Abandon run
async function abandonRun() {
    if (!currentRun || !confirm('Are you sure you want to abandon this run? You will lose all progress.')) return;
    
    try {
        await withLoading(async () => {
            const { error } = await supabase
                .from('runs')
                .delete()
                .eq('id', currentRun.id);
            
            if (error) throw error;
            
            currentRun = null;
            await loadCurrentRun();
            showNotification('Run abandoned', 'success');
        });
        
    } catch (error) {
        console.error('Error abandoning run:', error);
        showNotification('Error abandoning run: ' + error.message, 'error');
    }
}

// Pull gacha - FIXED VERSION
async function pullGacha(bannerId, multi = false) {
    try {
        if (!currentUser) return;
        
        const banner = gachaBanners.find(b => b.id === bannerId);
        if (!banner) {
            showNotification('Banner not found', 'error');
            return;
        }
        
        const cost = banner.cost * (multi ? 10 : 1);
        
        // Check if user has enough gold
        if (currentUser.gold < cost) {
            showNotification(`Not enough gold! Need ${cost} gold`, 'error');
            return;
        }
        
        await withLoading(async () => {
            // Deduct gold
            const newGold = currentUser.gold - cost;
            const { error: goldError } = await supabase
                .from('users')
                .update({ gold: newGold })
                .eq('id', currentUser.id);
            
            if (goldError) throw goldError;
            
            currentUser.gold = newGold;
            document.getElementById('gold-amount').textContent = newGold;
            
            // Get gacha rates for this banner
            const { data: rates, error: ratesError } = await supabase
                .from('gacha_rates')
                .select('*')
                .eq('banner_id', bannerId);
            
            if (ratesError) throw ratesError;
            
            if (!rates || rates.length === 0) {
                showNotification('No gacha rates found for this banner', 'error');
                return;
            }
            
            const pulls = multi ? 10 : 1;
            const obtainedItems = [];
            
            for (let i = 0; i < pulls; i++) {
                // Random selection based on rates
                const random = Math.random() * 100;
                let selectedRarity = 'common';
                let cumulative = 0;
                
                for (const rate of rates) {
                    if (!rate) continue;
                    cumulative += Number(rate.chance || 0);
                    if (random <= cumulative) {
                        selectedRarity = rate.rarity || 'common';
                        break;
                    }
                }
                
                // Get random equipment of selected rarity
                const { data: equipment, error: equipmentError } = await supabase
                    .from('equipment')
                    .select('*')
                    .eq('rarity', selectedRarity)
                    .limit(1);
                
                if (!equipmentError && equipment && equipment.length > 0) {
                    const item = equipment[0];
                    obtainedItems.push(item);
                    
                    // Add to player inventory - IMPORTANT: Ensure correct insertion
                    const { data: insertedItem, error: inventoryError } = await supabase
                        .from('player_equipment')
                        .insert([{
                            user_id: currentUser.id,
                            equipment_id: item.id,
                            is_equipped: false,
                            obtained_at: new Date().toISOString()
                        }])
                        .select();
                    
                    if (inventoryError) {
                        console.error('Error adding item to inventory:', inventoryError);
                        showNotification('Error adding item to inventory: ' + inventoryError.message, 'error');
                    } else {
                        console.log('Item added to inventory:', insertedItem);
                    }
                } else {
                    console.warn(`No equipment found for rarity: ${selectedRarity}`);
                }
            }
            
            // Filter out any undefined items
            const validItems = obtainedItems.filter(item => item != null);
            
            // Show results
            showGachaResults(validItems, multi);
            
            // Immediately refresh player data to show new items
            await loadPlayerData();
            updateUI();
            
            // Also reload gacha banners to update costs
            await loadGachaBanners();
            
            showNotification(multi ? '10-pull completed!' : 'Item obtained!', 'success');
        });
        
    } catch (error) {
        console.error('Error pulling gacha:', error);
        showNotification('Error pulling gacha: ' + error.message, 'error');
    }
}

// Multi-pull gacha
function pullGachaMulti(bannerId) {
    pullGacha(bannerId, true);
}

// Show gacha results
function showGachaResults(items, multi) {
    const modal = document.getElementById('gacha-modal');
    const contentDiv = document.getElementById('gacha-content');
    
    // Check if items is empty
    if (!items || items.length === 0) {
        contentDiv.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <h3>No Items Obtained</h3>
                <p>Try again later!</p>
                <button class="btn btn-primary" onclick="openGachaModal()">
                    BACK TO BANNERS
                </button>
            </div>
        `;
        return;
    }
    
    let resultsHTML = '';
    
    if (multi) {
        resultsHTML = `
            <div style="text-align: center;">
                <h3>10-PULL RESULTS!</h3>
                <div class="pull-animation">
                    <i class="fas fa-gift"></i>
                </div>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px;">
        `;
        
        items.forEach((item, index) => {
            if (!item) {
                resultsHTML += `
                    <div style="border: 2px solid #ccc; padding: 10px; text-align: center; background: var(--bg-panel);">
                        <div style="font-size: 24px; margin-bottom: 10px; color: #ccc">
                            <i class="fas fa-question"></i>
                        </div>
                        <div style="font-size: 12px; font-weight: 600;">No Item</div>
                        <div style="font-size: 10px; color: #ccc;">-</div>
                    </div>
                `;
                return;
            }
            
            const rarityColor = {
                common: '#808080',
                uncommon: '#00b85c',
                rare: '#5c7cfa',
                epic: '#9d4edd',
                legendary: '#ff9e4d'
            }[item.rarity || 'common'];
            
            resultsHTML += `
                <div style="border: 2px solid ${rarityColor}; padding: 10px; text-align: center; background: var(--bg-panel);">
                    <div style="font-size: 24px; margin-bottom: 10px; color: ${rarityColor}">
                        <i class="fas fa-${item.slot === 'weapon' ? 'sword' : 
                                          item.slot === 'shield' ? 'shield-alt' : 
                                          item.slot === 'helmet' ? 'helmet-battle' : 
                                          item.slot === 'chest' ? 'vest' : 
                                          item.slot === 'legs' ? 'running' : 
                                          item.slot === 'boots' ? 'boot' : 'question'}"></i>
                    </div>
                    <div style="font-size: 12px; font-weight: 600;">${item.name || 'Unknown Item'}</div>
                    <div style="font-size: 10px; color: ${rarityColor};">${(item.rarity || 'common').toUpperCase()}</div>
                </div>
            `;
        });
        
        resultsHTML += `
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="openGachaModal()">
                        BACK TO BANNERS
                    </button>
                </div>
            </div>
        `;
    } else {
        const item = items[0];
        if (!item) {
            resultsHTML = `
                <div style="text-align: center;">
                    <h3>YOU GOT...</h3>
                    <div class="pull-animation" style="color: #ccc">
                        <i class="fas fa-question" style="font-size: 64px;"></i>
                    </div>
                    <div style="margin-top: 20px; padding: 20px; background: var(--bg-panel); border: 2px solid #ccc;">
                        <h4>No Item</h4>
                        <p>No item was obtained. Please try again.</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="openGachaModal()">
                            PULL AGAIN
                        </button>
                    </div>
                </div>
            `;
        } else {
            const rarityColor = {
                common: '#808080',
                uncommon: '#00b85c',
                rare: '#5c7cfa',
                epic: '#9d4edd',
                legendary: '#ff9e4d'
            }[item.rarity || 'common'];
            
            resultsHTML = `
                <div style="text-align: center;">
                    <h3>YOU GOT!</h3>
                    <div class="pull-animation" style="color: ${rarityColor}">
                        <i class="fas fa-${item.slot === 'weapon' ? 'sword' : 
                                          item.slot === 'shield' ? 'shield-alt' : 
                                          item.slot === 'helmet' ? 'helmet-battle' : 
                                          item.slot === 'chest' ? 'vest' : 
                                          item.slot === 'legs' ? 'running' : 
                                          item.slot === 'boots' ? 'boot' : 'gift'}" 
                           style="font-size: 64px;"></i>
                    </div>
                    <div style="margin-top: 20px; padding: 20px; background: var(--bg-panel); border: 2px solid ${rarityColor};">
                        <h4>${item.name || 'Unknown Item'}</h4>
                        <div style="color: ${rarityColor}; margin: 10px auto; display: inline-block; padding: 5px 10px; border: 2px solid ${rarityColor}; font-weight: bold;">
                            ${(item.rarity || 'common').toUpperCase()}
                        </div>
                        <div style="margin-top: 10px;">
                            <div>Slot: ${item.slot || '-'}</div>
                            ${item.damage ? `<div>Damage: ${item.damage}</div>` : ''}
                            ${item.defense ? `<div>Defense: ${item.defense}</div>` : ''}
                            ${item.health_bonus ? `<div>HP Bonus: ${item.health_bonus}</div>` : ''}
                            ${item.crit_bonus ? `<div>Crit Bonus: ${(item.crit_bonus * 100).toFixed(1)}%</div>` : ''}
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="openGachaModal()">
                            PULL AGAIN
                        </button>
                    </div>
                </div>
            `;
        }
    }
    
    contentDiv.innerHTML = resultsHTML;
}

// Refresh all data
async function refreshData() {
    await withLoading(async () => {
        await loadPlayerData();
        await loadCurrentRun();
        await loadGachaBanners();
        await loadLeaderboard();
        updateUI();
        showNotification('Data refreshed', 'success');
    });
}

// Show notification
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type} show`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Logout
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        // Clear game state
        localStorage.removeItem('rpg-game-state');
        
        showNotification('Logged out successfully', 'success');
        setTimeout(() => {
            // Reload page to reset state
            window.location.reload();
        }, 1000);
    }
}

// Make functions globally available (for inline onclick handlers)
window.openInventoryModal = openInventoryModal;
window.closeInventoryModal = closeInventoryModal;
window.openGachaModal = openGachaModal;
window.closeGachaModal = closeGachaModal;
window.openSettingsModal = openSettingsModal;
window.closeSettingsModal = closeSettingsModal;
window.startNewRun = startNewRun;
window.continueRun = continueRun;
window.abandonRun = abandonRun;
window.pullGacha = pullGacha;
window.pullGachaMulti = pullGachaMulti;
window.equipItem = equipItem;
window.unequipItem = unequipItem;
window.selectInventoryItem = selectInventoryItem;
window.equipSlot = equipSlot;
window.logout = logout;
window.goToAdmin = goToAdmin;
window.closeErrorModal = closeErrorModal;
window.showItemTooltip = showItemTooltip;
window.hideTooltip = hideTooltip;
window.showStatDetails = showStatDetails;
</script>
</body>
</html>