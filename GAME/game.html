<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPG Battle</title>
<style>
/* [ALL CSS STAYS THE SAME - NO CHANGES NEEDED] */
:root {
    --bg-main: #f2efe6;
    --bg-panel: #e8e3d6;
    --border: #2b2b2b;
    --accent: #111;
    --tab-active: #d6c9a8;
    --tab-inactive: #e8e3d6;
    --green: #00b85c;
    --light-green: #c8ff7a;
    --bright-green: #b6ff5c;
    --yellow: #ffd84d;
    --red: #ff4d4d;
    --blue: #5c7cfa;
    --purple: #7e57c2;
    --cyan: #0097a7;
    --orange: #ffb74d;
}

* {
    box-sizing: border-box;
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 0;
}

body {
    margin: 0;
    background: #333;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 16px;
}

.app {
    width: 100%;
    max-width: 1000px;
    background: var(--bg-main);
    border: 3px solid var(--border);
    min-height: 700px;
}

/* [ALL OTHER CSS STAYS EXACTLY THE SAME] */
/* ... rest of CSS ... */
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="app">
    <!-- TOP BAR -->
    <div class="top-bar">
        <div class="profile">
            <div class="pfp" id="player-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="profile-info">
                <div style="font-weight: 700;">HIGH SCORE: <span id="player-highscore">-</span></div>
                <div>NAME: <span id="player-name">-</span></div>
                <div>POWER: <span id="player-power">-</span></div>
            </div>
        </div>
        
        <div class="stage-display">
            <div class="stage-main" id="current-stage">STAGE -</div>
            <div class="stage-sub" id="stage-level">LEVEL -</div>
        </div>
        
        <div class="gold-display">
            <i class="fas fa-coins"></i> GOLD<br>
            <span id="gold-amount">-</span>
        </div>
    </div>

    <!-- BATTLE AREA -->
    <div class="battle-area">
        <div class="monster-header">
            <div class="monster-name" id="monster-name">-</div>
            <div class="monster-category" id="monster-category">-</div>
        </div>
        
        <div class="monster-hp-container">
            <div class="hp-bar">
                <div class="hp-fill" id="monster-hp-bar" style="width: 100%"></div>
            </div>
            <div class="hp-text" id="monster-hp-text">HP: - / -</div>
        </div>
        
        <div class="battle-grid">
            <!-- PLAYER PANEL -->
            <div class="player-panel">
                <div class="panel-box difficulty" id="difficulty">-</div>
                <div class="panel-box player-stat">
                    <div class="stat-value" id="player-damage">-</div>
                    <div class="stat-label">DAMAGE</div>
                </div>
                <div class="panel-box player-stat">
                    <div class="stat-value" id="player-defense">-</div>
                    <div class="stat-label">DEFENSE</div>
                </div>
                <div class="panel-box player-stat">
                    <div class="stat-value" id="player-crit">-</div>
                    <div class="stat-label">CRIT CHANCE</div>
                </div>
            </div>
            
            <!-- MONSTER DISPLAY -->
            <div class="monster-display">
                <div class="monster-image" id="monster-image">
                    <i class="fas fa-question"></i>
                </div>
            </div>
            
            <!-- TIMER -->
            <div class="timer-container">
                <div class="timer" id="timer">
                    <span id="timer-seconds">-</span>
                    <div class="timer-ring" id="timer-ring"></div>
                </div>
                <div class="timer-text" id="timer-text">SECONDS REMAINING</div>
            </div>
        </div>
    </div>

    <!-- QUESTION SECTION -->
    <div class="question-section">
        <div class="question-header">
            <div class="question-category" id="question-category">-</div>
            <div class="question-difficulty" id="question-difficulty">-</div>
        </div>
        <div class="question-box" id="question-text">
            -
        </div>
        <div class="question-image" id="question-image"></div>
    </div>

    <!-- ANSWERS -->
    <div class="answers-section" id="answers-container">
        <div class="answer-option answer-a" data-index="0">
            <div class="option-label">A</div>
            <div class="answer-text" id="answer-text-0">-</div>
            <div class="answer-image" id="answer-image-0"></div>
        </div>
        <div class="answer-option answer-b" data-index="1">
            <div class="option-label">B</div>
            <div class="answer-text" id="answer-text-1">-</div>
            <div class="answer-image" id="answer-image-1"></div>
        </div>
        <div class="answer-option answer-c" data-index="2">
            <div class="option-label">C</div>
            <div class="answer-text" id="answer-text-2">-</div>
            <div class="answer-image" id="answer-image-2"></div>
        </div>
        <div class="answer-option answer-d" data-index="3">
            <div class="option-label">D</div>
            <div class="answer-text" id="answer-text-3">-</div>
            <div class="answer-image" id="answer-image-3"></div>
        </div>
    </div>

    <!-- PLAYER HEALTH -->
    <div class="player-health-section">
        <div class="health-container">
            <div class="health-bar">
                <div class="health-fill" id="player-hp-bar" style="width: 100%"></div>
            </div>
            <div class="health-text" id="player-hp-text">HEALTH: - / -</div>
        </div>
        
        <div class="flasks">
            <div class="flask" id="health-flask" onclick="useHealthFlask()">
                <i class="fas fa-flask"></i>
                <div class="flask-count" id="flask-count">-</div>
            </div>
            <div class="flask" onclick="toggleCombatLog()" style="background: var(--blue);">
                <i class="fas fa-scroll"></i>
            </div>
        </div>
    </div>
</div>

<!-- COMBAT LOG -->
<div class="combat-log" id="combat-log">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 style="margin: 0;">Combat Log</h4>
        <button class="btn" onclick="clearCombatLog()" style="font-size: 10px; padding: 4px 8px;">Clear</button>
    </div>
    <div id="log-entries"></div>
</div>

<!-- RESULT MODAL -->
<div class="modal" id="result-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="result-title">-</h3>
            <button class="close-btn" onclick="closeResultModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="result-content">
                <div class="loading">-</div>
            </div>
        </div>
    </div>
</div>

<!-- GAME OVER MODAL -->
<div class="modal" id="gameover-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--red);">GAME OVER</h3>
            <button class="close-btn" onclick="closeGameOverModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-skull-crossbones" style="font-size: 64px; color: var(--red); margin-bottom: 20px;"></i>
                <h4>You have been defeated!</h4>
                <p id="gameover-details">-</p>
                <p id="gameover-gold">-</p>
                <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="returnToLobby()">
                        <i class="fas fa-home"></i> LOBBY
                    </button>
                    <button class="btn btn-success" onclick="restartRun()">
                        <i class="fas fa-redo"></i> RETRY
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- STAGE CLEAR MODAL -->
<div class="modal" id="stageclear-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--green);">STAGE CLEAR!</h3>
            <button class="close-btn" onclick="closeStageClearModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-trophy" style="font-size: 64px; color: var(--yellow); margin-bottom: 20px;"></i>
                <h4>Monster Defeated!</h4>
                <p id="stageclear-details">-</p>
                <p id="stageclear-reward">-</p>
                <p id="stageclear-streak">-</p>
                <div style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="nextStage()">
                        <i class="fas fa-forward"></i> NEXT STAGE
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ERROR MODAL -->
<div class="modal" id="error-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--red);">ERROR</h3>
            <button class="close-btn" onclick="closeErrorModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: var(--red); margin-bottom: 20px;"></i>
                <h4 id="error-title">Game Setup Required</h4>
                <p id="error-message">No game data found. Please set up the game first.</p>
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="goToAdmin()">
                        <i class="fas fa-cog"></i> GO TO ADMIN PANEL
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
// Import Supabase client
import { supabase } from './supabase.js';

console.log('RPG Battle - Supabase client loaded');

// Game state
let gameState = {
    currentRun: null,
    playerStats: null,
    currentMonster: null,
    currentQuestion: null,
    questionOptions: [],
    selectedAnswer: null,
    timerInterval: null,
    timeLeft: 30,
    maxTime: 30,
    isAnswering: false,
    combatLog: [],
    healthFlasks: 3,
    streak: 0,
    goldEarned: 0,
    currentUser: null,
    monsterQuestions: [],      // All questions assigned to current monster
    currentQuestionIndex: 0    // Current question index in monsterQuestions array
};

// Initialize game
document.addEventListener('DOMContentLoaded', async () => {
    console.log('Initializing RPG Battle...');
    
    // Load game data
    await loadGameData();
    
    // Setup event listeners
    setupEventListeners();
});

// Load game data from Supabase
async function loadGameData() {
    try {
        console.log('Loading game data...');
        
        // Get current user
        const { data: users, error: usersError } = await supabase
            .from('users')
            .select('*')
            .order('created_at', { ascending: true })
            .limit(1);
        
        if (usersError) {
            console.error('Error loading users:', usersError);
            showError('Database Error', 'Could not load user data. Please check database connection.');
            return;
        }
        
        if (!users || users.length === 0) {
            showError('No User Found', 'Please create a user in the admin panel first.');
            return;
        }
        
        gameState.currentUser = users[0];
        console.log('Loaded user:', gameState.currentUser.username);
        
        // Update player info
        document.getElementById('player-name').textContent = gameState.currentUser.username || 'Player';
        document.getElementById('player-highscore').textContent = gameState.currentUser.highest_stage || 1;
        document.getElementById('gold-amount').textContent = gameState.currentUser.gold || 0;
        
        // Get player stats
        const { data: stats, error: statsError } = await supabase
            .from('player_stats')
            .select('*')
            .eq('user_id', gameState.currentUser.id)
            .single();
        
        if (statsError) {
            console.error('Error loading player stats:', statsError);
            // Create default stats if none exist
            gameState.playerStats = {
                base_hp: 100,
                base_damage: 10,
                base_defense: 5,
                crit_chance: 0.05
            };
            console.log('Using default player stats');
        } else {
            gameState.playerStats = stats;
            console.log('Loaded player stats');
        }
        
        // Get current run
        const { data: runs, error: runsError } = await supabase
            .from('runs')
            .select(`*, monster:current_monster (*)`)
            .eq('user_id', gameState.currentUser.id)
            .order('created_at', { ascending: false })
            .limit(1);
        
        if (runsError) {
            console.error('Error loading runs:', runsError);
            showError('Database Error', 'Could not load game data.');
            return;
        }
        
        if (runs && runs.length > 0) {
            gameState.currentRun = runs[0];
            console.log('Loaded existing run, stage:', gameState.currentRun.current_stage);
            
            // Load monster if available
            if (gameState.currentRun.current_monster) {
                await loadMonster(gameState.currentRun.current_monster);
            } else {
                // Get monster for current stage
                await loadMonsterForStage(gameState.currentRun.current_stage);
            }
            
            // Check if monsters exist
            if (!gameState.currentMonster) {
                console.log('No monster loaded, trying to load any monster');
                await loadAnyMonster();
            }
            
            updateRunDisplay();
            
            // Load monster-specific questions
            await loadMonsterQuestions(gameState.currentMonster.id);
            
            // Load first question
            await loadQuestion();
            
            // Start the game timer
            startTimer();
            
        } else {
            // No active run, create one
            console.log('No existing run, creating new run...');
            await createNewRun();
        }
        
    } catch (error) {
        console.error('Error loading game data:', error);
        showError('Game Error', 'Failed to load game. Please try again.');
    }
}

// Load any monster as fallback
async function loadAnyMonster() {
    try {
        const { data: monsters, error } = await supabase
            .from('monsters')
            .select('*')
            .order('stage', { ascending: true })
            .limit(1);
        
        if (error) throw error;
        
        if (monsters && monsters.length > 0) {
            gameState.currentMonster = monsters[0];
            console.log('Loaded fallback monster:', gameState.currentMonster.name);
            updateMonsterDisplay();
        } else {
            showError('No Monsters', 'Please add monsters to the database in the admin panel.');
        }
    } catch (error) {
        console.error('Error loading any monster:', error);
    }
}

// Create new run
async function createNewRun() {
    try {
        console.log('Creating new run...');
        
        // Check if monsters exist
        const { data: monsters, error: monstersError } = await supabase
            .from('monsters')
            .select('*')
            .eq('stage', 1)
            .limit(1);
        
        if (monstersError) throw monstersError;
        
        if (!monsters || monsters.length === 0) {
            // Try any monster
            const { data: anyMonsters, error: anyError } = await supabase
                .from('monsters')
                .select('*')
                .order('stage', { ascending: true })
                .limit(1);
            
            if (anyError) throw anyError;
            
            if (!anyMonsters || anyMonsters.length === 0) {
                showError('No Monsters', 'Please add monsters to the database in the admin panel.');
                return;
            }
            
            monsters = anyMonsters;
        }
        
        const monster = monsters[0];
        const playerHP = gameState.playerStats?.base_hp || 100;
        
        console.log('Creating run with monster:', monster.name);
        
        // Create run
        const { data: run, error: runError } = await supabase
            .from('runs')
            .insert([{
                user_id: gameState.currentUser.id,
                current_stage: 1,
                current_monster: monster.id,
                player_hp: playerHP,
                monster_hp: monster.hp,
                streak: 0,
                started_at: new Date().toISOString()
            }])
            .select()
            .single();
        
        if (runError) throw runError;
        
        gameState.currentRun = run;
        await loadMonster(monster.id);
        updateRunDisplay();
        
        // Load monster-specific questions
        await loadMonsterQuestions(monster.id);
        
        addToCombatLog('New run started!', 'info');
        
        // Load first question
        await loadQuestion();
        
        // Start timer
        startTimer();
        
    } catch (error) {
        console.error('Error creating new run:', error);
        showError('Run Creation Failed', 'Could not start new game. Please try again.');
    }
}

// Load monster data
async function loadMonster(monsterId) {
    try {
        console.log('Loading monster with ID:', monsterId);
        const { data: monster, error } = await supabase
            .from('monsters')
            .select('*')
            .eq('id', monsterId)
            .single();
        
        if (error) throw error;
        
        gameState.currentMonster = monster;
        updateMonsterDisplay();
        
    } catch (error) {
        console.error('Error loading monster:', error);
        gameState.currentMonster = null;
    }
}

// Load monster-specific questions
async function loadMonsterQuestions(monsterId) {
    try {
        console.log('Loading questions for monster:', monsterId);
        // Get all questions assigned to this monster
        const { data: monsterQuestions, error } = await supabase
            .from('monster_questions')
            .select(`question_order, questions (*)`)
            .eq('monster_id', monsterId)
            .order('question_order', { ascending: true });
        
        if (error) throw error;
        
        if (monsterQuestions && monsterQuestions.length > 0) {
            // Extract the questions from the result
            gameState.monsterQuestions = monsterQuestions.map(mq => ({
                ...mq.questions,
                question_order: mq.question_order
            }));
            gameState.currentQuestionIndex = 0;
            console.log(`Loaded ${gameState.monsterQuestions.length} specific questions for monster`);
        } else {
            // No specific questions assigned
            console.log('No specific questions assigned to monster');
            gameState.monsterQuestions = [];
            gameState.currentQuestionIndex = 0;
        }
        
    } catch (error) {
        console.error('Error loading monster questions:', error);
        gameState.monsterQuestions = [];
        gameState.currentQuestionIndex = 0;
    }
}

// Load monster for current stage
async function loadMonsterForStage(stage) {
    try {
        console.log('Loading monster for stage:', stage);
        const { data: monsters, error } = await supabase
            .from('monsters')
            .select('*')
            .eq('stage', stage)
            .limit(1);
        
        if (error) throw error;
        
        if (monsters && monsters.length > 0) {
            gameState.currentMonster = monsters[0];
            updateMonsterDisplay();
            
            // Load monster-specific questions
            await loadMonsterQuestions(gameState.currentMonster.id);
        }
        
    } catch (error) {
        console.error('Error loading monster for stage:', error);
    }
}

// Load question from database
async function loadQuestion() {
    try {
        console.log('Loading question...');
        
        // Reset selection
        gameState.selectedAnswer = null;
        gameState.isAnswering = false;
        
        // Clear previous selections
        document.querySelectorAll('.answer-option').forEach(option => {
            option.classList.remove('selected', 'correct', 'incorrect');
        });
        
        let question = null;
        
        // Check if we have monster-specific questions
        if (gameState.monsterQuestions && gameState.monsterQuestions.length > 0) {
            // Use monster-specific questions in order
            if (gameState.currentQuestionIndex >= gameState.monsterQuestions.length) {
                gameState.currentQuestionIndex = 0; // Reset to start if we've gone through all questions
            }
            
            question = gameState.monsterQuestions[gameState.currentQuestionIndex];
            console.log(`Using monster-specific question ${gameState.currentQuestionIndex + 1}/${gameState.monsterQuestions.length}`);
            
            // Move to next question
            gameState.currentQuestionIndex++;
            
        } else {
            // Fallback: Get random question
            console.log('Using fallback: random question');
            
            // Check if questions exist
            const { data: questionsCount, error: countError } = await supabase
                .from('questions')
                .select('*', { count: 'exact', head: true });
            
            if (countError) throw countError;
            
            if (!questionsCount || questionsCount === 0) {
                addToCombatLog('No questions available in database!', 'error');
                // Create a dummy question
                question = {
                    id: 'dummy',
                    question_text: 'What is 2 + 2?',
                    category: 'Math',
                    difficulty: 'Easy',
                    timer_seconds: 30
                };
            } else {
                // Get random question, optionally filtered by monster category
                let query = supabase.from('questions').select('*');
                
                // Filter by monster category if available
                if (gameState.currentMonster?.category) {
                    query = query.eq('category', gameState.currentMonster.category);
                }
                
                const { data: questions, error } = await query;
                
                if (error) throw error;
                
                if (!questions || questions.length === 0) {
                    // Fallback to any question
                    const { data: allQuestions, error: allError } = await supabase
                        .from('questions')
                        .select('*');
                    
                    if (allError) throw allError;
                    
                    if (!allQuestions || allQuestions.length === 0) {
                        // Create dummy question
                        question = {
                            id: 'dummy',